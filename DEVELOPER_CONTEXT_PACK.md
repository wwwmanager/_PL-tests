# üöõ Waybill Management System ‚Äî Developer Context Pack

> **–í–µ—Ä—Å–∏—è:** 2.1 | **–î–∞—Ç–∞:** 2025-12-28 | **Target:** Onboarding —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è](#1-–æ–±–∑–æ—Ä-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
2. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#2-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#3-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
4. [–î–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Prisma)](#4-–¥–æ–º–µ–Ω–Ω—ã–µ-–º–æ–¥–µ–ª–∏-prisma)
5. [API Endpoints](#5-api-endpoints)
6. [Frontend —Å—Ç—Ä—É–∫—Ç—É—Ä–∞](#6-frontend-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
7. [–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ RBAC](#7-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è-–∏-rbac)
8. [–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤](#8-–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞-–∫–ª—é—á–µ–≤—ã—Ö-–¥–æ–º–µ–Ω–æ–≤)
9. [–¢–∏–ø–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è](#9-—Ç–∏–ø–∏—á–Ω—ã–µ-–ø–∞—Ç—Ç–µ—Ä–Ω—ã-–∏-—Å–æ–≥–ª–∞—à–µ–Ω–∏—è)
10. [–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è](#10-–∏–∑–≤–µ—Å—Ç–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã-–∏-—Ä–µ—à–µ–Ω–∏—è)
11. [–ó–∞–ø—É—Å–∫ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞](#11-–∑–∞–ø—É—Å–∫-–∏-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
12. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#12-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

## 1. –û–±–∑–æ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**Waybill Management System** ‚Äî B2B SaaS-—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —É—á–µ—Ç–∞ –ø—É—Ç–µ–≤—ã—Ö –ª–∏—Å—Ç–æ–≤ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–π –ª–æ–≥–∏—Å—Ç–∏–∫–∏ (–†–§).

### –ö–ª—é—á–µ–≤—ã–µ –¥–æ–º–µ–Ω—ã:

| –î–æ–º–µ–Ω | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| **–ü—É—Ç–µ–≤—ã–µ –ª–∏—Å—Ç—ã (–ü–õ)** | –°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ. –£—á—ë—Ç –æ–¥–æ–º–µ—Ç—Ä–∞, —Ä–∞—Å—Ö–æ–¥–∞ —Ç–æ–ø–ª–∏–≤–∞, –º–∞—Ä—à—Ä—É—Ç–æ–≤ |
| **–ë–°–û (–ë–ª–∞–Ω–∫–∏)** | –£—á—ë—Ç –±–ª–∞–Ω–∫–æ–≤ —Å—Ç—Ä–æ–≥–æ–π –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏. –ü–∞—á–∫–∏ ‚Üí –≤—ã–¥–∞—á–∞ ‚Üí —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ‚Üí —Å–ø–∏—Å–∞–Ω–∏–µ |
| **–°–∫–ª–∞–¥** | –î–≤–∏–∂–µ–Ω–∏–µ –¢–ú–¶ (INCOME/EXPENSE/ADJUSTMENT/TRANSFER), –±–∞–ª–∞–Ω—Å—ã, —Ç–æ–ø–ª–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã |
| **–¢–æ–ø–ª–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –≤–æ–¥–∏—Ç–µ–ª—è–º, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ, –±–∞–ª–∞–Ω—Å |
| **–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏** | –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, –≤–æ–¥–∏—Ç–µ–ª–∏, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, —Ç–∏–ø—ã —Ç–æ–ø–ª–∏–≤–∞ |
| **RBAC** | –†–æ–ª–∏, –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (permissions), –ø—Ä–æ–≤–µ—Ä–∫–∞ checkPermission |

### –ú—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å:
- –ò–∑–æ–ª—è—Ü–∏—è –ø–æ `organizationId` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –ø–æ `departmentId`
- `authMiddleware` –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ `req.user`: `{ id, organizationId, departmentId, role }`

---

## 2. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Frontend

| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| React | 19.2.0 | UI-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ |
| Vite | 6.0.7 | –°–±–æ—Ä–∫–∞ –∏ dev-—Å–µ—Ä–≤–µ—Ä |
| TypeScript | 5.8.3 | –¢–∏–ø–∏–∑–∞—Ü–∏—è |
| Tailwind CSS | 3.4.17 | –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è |
| Zod | 3.22.4 | –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º |
| React Hook Form | 7.51.0 | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–º–∏ |
| Recharts | 3.5.1 | –ì—Ä–∞—Ñ–∏–∫–∏ (Dashboard) |
| Playwright | 1.43.0 | E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ |

### Backend

| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| Node.js | LTS | –†–∞–Ω—Ç–∞–π–º |
| Express | 4.21.2 | HTTP-—Å–µ—Ä–≤–µ—Ä |
| TypeScript | 5.4.0 | –¢–∏–ø–∏–∑–∞—Ü–∏—è |
| Prisma | 5.22.0 | ORM |
| PostgreSQL | 14+ | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö |
| Zod | 4.2.1 | DTO-–≤–∞–ª–∏–¥–∞—Ü–∏—è |
| JWT | 9.0.2 | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è |
| bcrypt | 5.1.0 | –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π |
| Pino | 10.1.0 | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ |

---

## 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
üì¶ waybill-app/
‚îú‚îÄ‚îÄ üìÅ backend/                    # Express API —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ prisma/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma          # üîë –°—Ö–µ–º–∞ –ë–î (721 —Å—Ç—Ä–æ–∫–∞, 30+ –º–æ–¥–µ–ª–µ–π)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations/            # –ú–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ seed.ts                # –°–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ controllers/        # 22 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ services/           # 17 —Å–µ—Ä–≤–∏—Å–æ–≤ (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ routes/             # 22 —Ä–æ—É—Ç-—Ñ–∞–π–ª–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ middleware/         # auth, RBAC, requestId
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ dto/                # Zod-—Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ utils/              # –£—Ç–∏–ª–∏—Ç—ã (jwt, errors, dateUtils)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ domain/             # –î–æ–º–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.ts                 # Express app
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server.ts              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ tests/                  # Unit/Integration —Ç–µ—Å—Ç—ã
‚îÇ
‚îú‚îÄ‚îÄ üìÅ components/                 # React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ admin/                  # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (19 —Ñ–∞–π–ª–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ waybills/               # –ü—É—Ç–µ–≤—ã–µ –ª–∏—Å—Ç—ã (9 —Ñ–∞–π–ª–æ–≤)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WaybillList.tsx        # –ñ—É—Ä–Ω–∞–ª –ü–õ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WaybillDetail.tsx      # –ö–∞—Ä—Ç–æ—á–∫–∞ –ü–õ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BatchGeneratorModal.tsx # –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ü–õ
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ vehicles/               # –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ employees/              # –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ dictionaries/           # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ dashboard/              # –î–∞—à–±–æ—Ä–¥
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ reports/                # –û—Ç—á—ë—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ shared/                 # –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (Modal, Form, etc.)
‚îÇ
‚îú‚îÄ‚îÄ üìÅ services/                   # API-–∫–ª–∏–µ–Ω—Ç—ã –∏ –¥–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ api/                    # –§–∞—Å–∞–¥—ã API (16 —Ñ–∞–π–ª–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ httpClient.ts              # HTTP-–∫–ª–∏–µ–Ω—Ç —Å –∏–Ω—Ç–µ—Ä—Ü–µ–ø—Ç–æ—Ä–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ auth.tsx                   # AuthProvider
‚îÇ   ‚îî‚îÄ‚îÄ schemas.ts                 # Zod-—Å—Ö–µ–º—ã frontend
‚îÇ
‚îú‚îÄ‚îÄ üìÅ hooks/                      # –ö–∞—Å—Ç–æ–º–Ω—ã–µ React —Ö—É–∫–∏
‚îú‚îÄ‚îÄ üìÅ contexts/                   # React –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã
‚îú‚îÄ‚îÄ üìÅ utils/                      # –£—Ç–∏–ª–∏—Ç—ã frontend
‚îú‚îÄ‚îÄ üìÅ tests/                      # E2E —Ç–µ—Å—Ç—ã Playwright
‚îÇ
‚îú‚îÄ‚îÄ types.ts                       # üîë –ì–ª–∞–≤–Ω—ã–µ —Ç–∏–ø—ã (516 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ constants.ts                   # –ü–µ—Ä–µ–≤–æ–¥—ã, —Ü–≤–µ—Ç–∞, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
‚îú‚îÄ‚îÄ App.tsx                        # Root –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚îî‚îÄ‚îÄ index.tsx                      # Entry point
```

---

## 4. –î–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Prisma)

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏

```mermaid
erDiagram
    Organization ||--o{ Department : has
    Organization ||--o{ User : has
    Organization ||--o{ Employee : has
    Organization ||--o{ Vehicle : has
    Organization ||--o{ Waybill : has
    Organization ||--o{ BlankBatch : has
    
    Department ||--o{ User : has
    Department ||--o{ Waybill : has
    
    Employee ||--o| Driver : "may be"
    Employee ||--o| User : "may be linked"
    Driver ||--o{ Waybill : drives
    
    Vehicle ||--o{ Waybill : used_in
    Blank ||--o| Waybill : reserved_for
    
    Waybill ||--o{ WaybillRoute : has
    Waybill ||--o{ WaybillFuel : has
```

### –ö–ª—é—á–µ–≤—ã–µ Enums

```typescript
// –°—Ç–∞—Ç—É—Å—ã –ø—É—Ç–µ–≤–æ–≥–æ –ª–∏—Å—Ç–∞
enum WaybillStatus {
  DRAFT      // –ß–µ—Ä–Ω–æ–≤–∏–∫
  SUBMITTED  // –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
  POSTED     // –ü—Ä–æ–≤–µ–¥—ë–Ω (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π)
  CANCELLED  // –û—Ç–º–µ–Ω—ë–Ω
}

// –°—Ç–∞—Ç—É—Å—ã –±–ª–∞–Ω–∫–∞ –ë–°–û
enum BlankStatus {
  AVAILABLE  // –ù–∞ —Å–∫–ª–∞–¥–µ
  ISSUED     // –í—ã–¥–∞–Ω –≤–æ–¥–∏—Ç–µ–ª—é
  RESERVED   // –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –ü–õ
  USED       // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
  RETURNED   // –í–æ–∑–≤—Ä–∞—â—ë–Ω
  SPOILED    // –ò—Å–ø–æ—Ä—á–µ–Ω
}

// –°—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
enum VehicleStatus {
  ACTIVE = 'Active'    // ‚ö†Ô∏è PascalCase!
  ARCHIVED = 'Archived'
}
```

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–¥–µ–ª–∏

| –ú–æ–¥–µ–ª—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è |
|--------|------------|---------------|
| `Organization` | –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è (–≥–ª–∞–≤–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è) | `id`, `name`, `status` |
| `User` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã | `organizationId`, `email`, `passwordHash`, `tokenVersion` |
| `Employee` | –°–æ—Ç—Ä—É–¥–Ω–∏–∫ | `employeeType` (driver/dispatcher/etc), `isActive` |
| `Driver` | –í–æ–¥–∏—Ç–µ–ª—å (—Å–≤—è–∑—å 1:1 —Å Employee) | `employeeId`, `licenseNumber` |
| `Vehicle` | –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ | `registrationNumber`, `fuelConsumptionRates`, `isActive` |
| `Waybill` | –ü—É—Ç–µ–≤–æ–π –ª–∏—Å—Ç | `status`, `blankId` (unique!), `driverId`, `vehicleId` |
| `Blank` | –ë–ª–∞–Ω–∫ –ë–°–û | `series`, `number`, `status`, `issuedToDriverId` |
| `StockMovement` | –î–≤–∏–∂–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞ | `movementType`, `quantity`, `stockItemId` |

---

## 5. API Endpoints

### –ë–∞–∑–æ–≤—ã–π URL: `/api`

| –ú–µ—Ç–æ–¥ | Endpoint | –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|------------|----------|
| **Auth** ||||
| POST | `/auth/login` | authController | –õ–æ–≥–∏–Ω, –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ |
| POST | `/auth/refresh` | authController | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access token |
| POST | `/auth/logout` | authController | Logout (–æ—Ç–∑—ã–≤ refresh token) |
| GET | `/me` | meController | –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **Waybills** ||||
| GET | `/waybills` | waybillController | –°–ø–∏—Å–æ–∫ –ü–õ (—Ñ–∏–ª—å—Ç—Ä—ã) |
| POST | `/waybills` | waybillController | –°–æ–∑–¥–∞–Ω–∏–µ –ü–õ |
| GET | `/waybills/:id` | waybillController | –ü–æ–ª—É—á–∏—Ç—å –ü–õ –ø–æ ID |
| PUT | `/waybills/:id` | waybillController | –û–±–Ω–æ–≤–∏—Ç—å –ü–õ |
| DELETE | `/waybills/:id` | waybillController | –£–¥–∞–ª–∏—Ç—å –ü–õ |
| PATCH | `/waybills/:id/status` | waybillController | –°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ (RBAC!) |
| **Vehicles** ||||
| GET | `/vehicles` | vehicleController | –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ |
| POST | `/vehicles` | vehicleController | –°–æ–∑–¥–∞—Ç—å –¢–° |
| PUT | `/vehicles/:id` | vehicleController | –û–±–Ω–æ–≤–∏—Ç—å –¢–° |
| DELETE | `/vehicles/:id` | vehicleController | –£–¥–∞–ª–∏—Ç—å –¢–° |
| **Employees** ||||
| GET | `/employees` | employeeController | –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ |
| POST | `/employees` | employeeController | –°–æ–∑–¥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ |
| PUT | `/employees/:id` | employeeController | –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ |
| **Blanks** ||||
| GET | `/blanks` | blankController | –°–ø–∏—Å–æ–∫ –±–ª–∞–Ω–∫–æ–≤ |
| POST | `/blanks/batches` | blankController | –°–æ–∑–¥–∞—Ç—å –ø–∞—á–∫—É –±–ª–∞–Ω–∫–æ–≤ |
| POST | `/blanks/issue` | blankController | –í—ã–¥–∞—Ç—å –±–ª–∞–Ω–∫–∏ –≤–æ–¥–∏—Ç–µ–ª—é |
| POST | `/blanks/:id/spoil` | blankController | –°–ø–∏—Å–∞—Ç—å –±–ª–∞–Ω–∫ |
| **Stock** ||||
| GET | `/stock/items` | stockController | –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ |
| GET | `/stock/movements` | stockController | –î–≤–∏–∂–µ–Ω–∏—è |
| POST | `/stock/movements` | stockController | –°–æ–∑–¥–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ |
| **Admin** ||||
| POST | `/admin/import` | adminController | –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö |
| POST | `/admin/export` | adminController | –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö |
| POST | `/admin/selective-delete` | adminController | –í—ã–±–æ—Ä–æ—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ |

---

## 6. Frontend —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ Views (App.tsx)

```typescript
type View =
  | 'DASHBOARD'      // –î–∞—à–±–æ—Ä–¥ —Å KPI
  | 'WAYBILLS'       // –ñ—É—Ä–Ω–∞–ª –ø—É—Ç–µ–≤—ã—Ö –ª–∏—Å—Ç–æ–≤
  | 'DICTIONARIES'   // –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (–≤–∫–ª–∞–¥–∫–∏)
  | 'WAREHOUSE'      // –°–∫–ª–∞–¥—Å–∫–æ–π —É—á—ë—Ç
  | 'REPORTS'        // –û—Ç—á—ë—Ç—ã
  | 'ADMIN'          // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
  | 'BLANKS'         // –£—á—ë—Ç –±–ª–∞–Ω–∫–æ–≤ –ë–°–û
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
components/
‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îú‚îÄ‚îÄ Admin.tsx                 # –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∞–¥–º–∏–Ω–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ DataDeletionModal.tsx     # –í—ã–±–æ—Ä–æ—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ ImportPreviewModal.tsx    # –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–º–ø–æ—Ä—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ UserManagement.tsx        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ RoleManagement.tsx        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏
‚îÇ
‚îú‚îÄ‚îÄ waybills/
‚îÇ   ‚îú‚îÄ‚îÄ WaybillList.tsx           # –ñ—É—Ä–Ω–∞–ª –ü–õ
‚îÇ   ‚îú‚îÄ‚îÄ WaybillDetail.tsx         # –ö–∞—Ä—Ç–æ—á–∫–∞ –ü–õ (—Å–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
‚îÇ   ‚îú‚îÄ‚îÄ WaybillRouteEditor.tsx    # –†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ WaybillFuelPanel.tsx      # –ü–∞–Ω–µ–ª—å —Ç–æ–ø–ª–∏–≤–∞
‚îÇ   ‚îî‚îÄ‚îÄ BatchGeneratorModal.tsx   # –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ü–õ –∏–∑ HTML-–æ—Ç—á—ë—Ç–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ vehicles/
‚îÇ   ‚îî‚îÄ‚îÄ VehicleList.tsx           # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ employees/
‚îÇ   ‚îî‚îÄ‚îÄ EmployeeList.tsx          # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îú‚îÄ‚îÄ Modal.tsx                 # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–æ–¥–∞–ª
‚îÇ   ‚îú‚îÄ‚îÄ CollapsibleSection.tsx    # –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è —Å–µ–∫—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ ConfirmationModal.tsx     # –ú–æ–¥–∞–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ FormComponents.tsx        # FormField, FormInput, FormSelect
```

### –ü–∞—Ç—Ç–µ—Ä–Ω API-—Ñ–∞—Å–∞–¥–æ–≤

```typescript
// services/api/vehicleApi.ts
export async function getVehicles(): Promise<Vehicle[]> {
  return httpClient.get<Vehicle[]>('/vehicles');
}

export async function updateVehicle(data: Vehicle): Promise<Vehicle> {
  const { id, ...updateData } = data;
  const payload = sanitizeVehiclePayload(updateData);
  return httpClient.put<Vehicle>(`/vehicles/${id}`, payload);
}
```

---

## 7. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ RBAC

### JWT Flow

```mermaid
sequenceDiagram
    participant C as Client
    participant A as API
    participant DB as Database
    
    C->>A: POST /auth/login (email, password)
    A->>DB: Verify credentials
    DB-->>A: User + Roles
    A-->>C: { accessToken, refreshToken }
    
    Note over C,A: Access Token (15 min, in memory)
    Note over C,A: Refresh Token (7 days, httpOnly cookie)
    
    C->>A: GET /vehicles (Authorization: Bearer <accessToken>)
    A->>A: authMiddleware: verify JWT, extract user
    A->>A: checkPermission('vehicle.read')
    A-->>C: 200 OK / 403 Forbidden
```

### –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞

```typescript
type Role = 
  | 'admin'      // –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
  | 'dispatcher' // –î–∏—Å–ø–µ—Ç—á–µ—Ä
  | 'driver'     // –í–æ–¥–∏—Ç–µ–ª—å
  | 'accountant' // –ë—É—Ö–≥–∞–ª—Ç–µ—Ä
  | 'mechanic'   // –ú–µ—Ö–∞–Ω–∏–∫
  | 'auditor'    // –ê—É–¥–∏—Ç–æ—Ä
  | 'reviewer'   // –ü—Ä–æ–≤–µ—Ä—è—é—â–∏–π
  | 'viewer';    // –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä

// –ü—Ä–∏–º–µ—Ä—ã capabilities
type Capability =
  | 'waybill.create'
  | 'waybill.submit'
  | 'waybill.post'
  | 'blanks.issue'
  | 'admin.panel'
  | 'audit.read';
```

### Token Versioning (AUTH-003)

–î–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏/—Ä–æ–ª–∏:
- `User.tokenVersion` —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î
- `tokenVersion` –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ JWT payload
- –ü—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–∞–≤ –≤–µ—Ä—Å–∏—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
- `authMiddleware` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π

---

## 8. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤

### 8.1 –ü—É—Ç–µ–≤—ã–µ –ª–∏—Å—Ç—ã (Waybill)

#### –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (Architecture Decision)
- **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ü–õ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `getWaybillById(id)`, –∑–∞–≥—Ä—É–∂–∞—é—â–∏–π –ø–æ–ª–Ω—ã–π –≥—Ä–∞—Ñ (–æ–±—ä–µ–∫—Ç + –º–∞—Ä—à—Ä—É—Ç—ã + –ª–∏–Ω–∏–∏ —Ç–æ–ø–ª–∏–≤–∞). –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–ø–∏—Å–∫–∞ (`listWaybills`) –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —Å–ø–∏—Å–æ–∫ –æ—Ç–¥–∞–µ—Ç —É—Ä–µ–∑–∞–Ω–Ω—ã–π DTO.
- **–î–∞—Ç—ã:**
  - `date`: –•—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ Date (Start of Day) –∏–ª–∏ —Å—Ç—Ä–æ–∫–∞ `YYYY-MM-DD`. –û–∑–Ω–∞—á–∞–µ—Ç –¥–∞—Ç—É –≤—ã–µ–∑–¥–∞.
  - `validTo`: –•—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ ISO —Å—Ç—Ä–æ–∫—É —Å –≤—Ä–µ–º–µ–Ω–µ–º (`datatime`). –í UI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `datetime-local`.
  - –ú–∞–ø–ø–∏–Ω–≥: `validFrom` —É–¥–∞–ª–µ–Ω –∏–∑ DTO save-payload, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–ª–ª–∏–∑–∏–π —Å `date`.

#### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

```mermaid
stateDiagram-v2
    [*] --> DRAFT: –°–æ–∑–¥–∞–Ω–∏–µ
    DRAFT --> SUBMITTED: Submit (waybill.submit)
    DRAFT --> CANCELLED: Cancel
    SUBMITTED --> POSTED: Post (waybill.post)
    SUBMITTED --> CANCELLED: Cancel
    POSTED --> [*]: –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    CANCELLED --> [*]: –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
```

#### –†–∞—Å—á—ë—Ç —Ç–æ–ø–ª–∏–≤–∞ (fuelPlanned)

```typescript
enum FuelCalculationMethod {
  BOILER   // –ö–æ—Ç–ª–æ–≤–æ–π: –±–∞–∑–æ–≤–∞—è –Ω–æ—Ä–º–∞ √ó –ø—Ä–æ–±–µ–≥
  SEGMENTS // –ü–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º: —Å—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞–∂–¥–æ–º—É —É—á–∞—Å—Ç–∫—É
  MIXED    // –°–º–µ—à–∞–Ω–Ω—ã–π: —Å—Ä–µ–¥–Ω—è—è –Ω–æ—Ä–º–∞ √ó –æ–¥–æ–º–µ—Ç—Ä
}

// –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è:
// - –ó–∏–º–Ω—è—è/–ª–µ—Ç–Ω—è—è –Ω–æ—Ä–º–∞ (–ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏)
// - –ì–æ—Ä–æ–¥—Å–∫–æ–π —Ü–∏–∫–ª (+cityIncreasePercent%)
// - –ü—Ä–æ–≥—Ä–µ–≤ (+warmingIncreasePercent%)
```

#### –ü—Ä–æ–≤–æ–¥–∫–∞ (POSTED)

–í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:
1. –°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–ø–ª–∏–≤–∞ —Å–æ —Å–∫–ª–∞–¥–∞ (`StockMovement EXPENSE`)
2. –ü–µ—Ä–µ–≤–æ–¥ –±–ª–∞–Ω–∫–∞ –≤ `USED`
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ü–õ
4. –ó–∞–ø–∏—Å—å –≤ `AuditLog`

#### –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ü–õ (Batch Generation)

–§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—É—Ç–µ–≤—ã—Ö –ª–∏—Å—Ç–æ–≤ –∏–∑ HTML-–æ—Ç—á—ë—Ç–æ–≤ —Å–∏—Å—Ç–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `BatchGeneratorModal.tsx` ‚Äî UI –º–æ–¥–∞–ª (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚Üí –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞)
- `batchWaybillService.ts` ‚Äî –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏—è –ü–õ

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–≥—Ä—É–∑–∫–∞ HTML-—Ñ–∞–π–ª–∞ —Å –ø–æ–µ–∑–¥–∫–∞–º–∏
2. –ü–∞—Ä—Å–∏–Ω–≥ –º–∞—Ä—à—Ä—É—Ç–æ–≤ (`routeParserService`)
3. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–Ω—è–º/–Ω–µ–¥–µ–ª—è–º/–º–µ—Å—è—Ü–∞–º
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ü–õ
5. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ü–õ —Å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ–º –±–ª–∞–Ω–∫–æ–≤

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Driver.id` (–Ω–µ `Employee.id`) –¥–ª—è `driverId`
- –ü–æ–ª—É—á–∞—Ç—å –±–ª–∞–Ω–∫–∏ —á–µ—Ä–µ–∑ `getAvailableBlanksForDriver(driverId)` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–ª–∞–Ω–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `ISSUED`
- –í—Å–µ —á–∏—Å–ª–∞ (mileage, distance) –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –≤ `Number()` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫

### 8.2 –ë–ª–∞–Ω–∫–∏ –ë–°–û (Blank)

#### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

```
AVAILABLE ‚Üí ISSUED ‚Üí RESERVED ‚Üí USED
              ‚Üì         ‚Üì
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚Üí SPOILED
              ‚Üë         ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò (release –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –ü–õ)
```

#### –ö–ª—é—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

| –û–ø–µ—Ä–∞—Ü–∏—è | –ü–µ—Ä–µ—Ö–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ | –¢—Ä–∏–≥–≥–µ—Ä |
|----------|-----------------|---------|
| `issue` | AVAILABLE ‚Üí ISSUED | –í—ã–¥–∞—á–∞ –≤–æ–¥–∏—Ç–µ–ª—é |
| `reserve` | ISSUED ‚Üí RESERVED | –°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–õ |
| `release` | RESERVED ‚Üí ISSUED | –£–¥–∞–ª–µ–Ω–∏–µ/–æ—Ç–º–µ–Ω–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –ü–õ |
| `use` | RESERVED ‚Üí USED | –ü—Ä–æ–≤–æ–¥–∫–∞ –ü–õ |
| `spoil` | * ‚Üí SPOILED | –°–ø–∏—Å–∞–Ω–∏–µ –±–ª–∞–Ω–∫–∞ |

#### –ì–∞—Ä–∞–Ω—Ç–∏–∏

- `Waybill.blankId` ‚Äî **—É–Ω–∏–∫–∞–ª—å–Ω—ã–π** (1 –±–ª–∞–Ω–∫ = 1 –ü–õ)
- –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –≥–æ–Ω–æ–∫ (–∏–Ω–¥–µ–∫—Å—ã + —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)

### 8.3 –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (Vehicle)

#### ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω—ã–π –º–æ–º–µ–Ω—Ç: Status vs isActive

```typescript
// Frontend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç enum VehicleStatus
enum VehicleStatus {
  ACTIVE = 'Active',    // PascalCase!
  ARCHIVED = 'Archived'
}

// Backend —Ö—Ä–∞–Ω–∏—Ç boolean isActive
// –ü—Ä–∏ —á—Ç–µ–Ω–∏–∏: isActive ‚Üí status ('Active'/'Archived')
// –ü—Ä–∏ –∑–∞–ø–∏—Å–∏: status ‚Üí isActive (true/false)
```

**–ü—Ä–∞–≤–∏–ª–æ:** –ë—ç–∫–µ–Ω–¥ –î–û–õ–ñ–ï–ù –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `status: 'Active'` (–Ω–µ `'ACTIVE'`!) –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è frontend enum.

---

## 9. –¢–∏–ø–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è

### 9.1 Sanitize Payload

–§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ –±—ç–∫–µ–Ω–¥ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ:

```typescript
// services/api/vehicleApi.ts
function sanitizeVehiclePayload(data) {
  // –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Üí null
  // status ‚Üí isActive —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  // –í–∞–ª–∏–¥–∞—Ü–∏—è fuelConsumptionRates
}
```

### 9.2 –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Å–∫–æ—É–ø—è—Ç—Å—è –ø–æ `organizationId`:

```typescript
// –ë—ç–∫–µ–Ω–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç
const vehicles = await prisma.vehicle.findMany({
  where: { organizationId: req.user.organizationId }
});
```

### 9.3 Form + Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è

```tsx
const schema = z.object({
  registrationNumber: z.string().min(1),
  mileage: z.number().min(0),
  status: z.nativeEnum(VehicleStatus),
});

const { register, handleSubmit } = useForm({
  resolver: zodResolver(schema),
});
```

### 9.4 –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```typescript
// Backend
throw new NotFoundError('–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
throw new BadRequestError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
throw new UnauthorizedError('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
throw new ForbiddenError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');

// Frontend (EmptyState)
const reason = getEmptyStateFromError(error);
// ‚Üí { type: 'error', entityName: '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç' }
// ‚Üí { type: 'forbidden' }
// ‚Üí { type: 'loading' }
```
9.5 –§–æ—Ä–º–∞—Ç –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏: Jira + –∑–∞–ø—Ä–æ—Å—ã –∫ –∞–≥–µ–Ω—Ç—É
–ü—Ä–∞–≤–∏–ª–æ:

–í—Å–µ –∑–∞–¥–∞—á–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ Jira-—Ç–∏–∫–µ—Ç—ã.
–ï—Å–ª–∏ –Ω—É–∂–Ω—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –∫–æ–¥—É/–∫–æ–Ω—Ñ–∏–≥—É ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç ‚Äú–ó–∞–ø—Ä–æ—Å –∞–≥–µ–Ω—Ç—É‚Äù —Å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤.
–®–∞–±–ª–æ–Ω —Ç–∏–∫–µ—Ç–∞:

ID ‚Äî –ù–∞–∑–≤–∞–Ω–∏–µ
–ö–æ–Ω—Ç–µ–∫—Å—Ç
–ü—Ä–æ–±–ª–µ–º–∞
–¶–µ–ª—å
–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å (Backend/Frontend/Tests)
–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
–†–∏—Å–∫–∏/–ü—Ä–∏–º–µ—á–∞–Ω–∏—è
–ó–∞–ø—Ä–æ—Å –∞–≥–µ–Ω—Ç—É (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
---

## 10. –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞ `'ACTIVE'` vs `'Active'`

**–†–µ—à–µ–Ω–∏–µ:** –í `vehicleService.ts` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
```typescript
status: v.isActive ? 'Active' : 'Archived'  // –ù–ï 'ACTIVE'!
```

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –ü—É—Å—Ç—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏

**–ü—Ä–∏—á–∏–Ω—ã:**
1. `organizationId` –≤ —Ç–æ–∫–µ–Ω–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –¥—Ä—É–≥—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é
2. –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –º–µ–∂–¥—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** GET `/me` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: Employee vs Driver

**–ü—Ä–∞–≤–∏–ª–æ:** –í–µ–∑–¥–µ, –≥–¥–µ —Ä–µ—á—å –æ –≤–æ–¥–∏—Ç–µ–ª–µ –∏ –±–ª–∞–Ω–∫–∞—Ö/–ü–õ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Driver.id`, –ù–ï `Employee.id`!

–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç: –µ—Å–ª–∏ `employeeType = 'driver'`, –∑–∞–ø–∏—Å—å `Driver` –¥–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å.

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –ü–∞–∫–µ—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Äî —á–∏—Å–ª–æ–≤—ã–µ —Ç–∏–ø—ã

**–ü—Ä–∏—á–∏–Ω–∞:** `vehicle.mileage` –∏ `totalDistance` –º–æ–≥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏, –≤—ã–∑—ã–≤–∞—è –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—é –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–µ–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Number()` –¥–ª—è –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
```typescript
const endOdo = Number(startOdo) + Number(distance);
let runningOdometer = Number(vehicle.mileage) || 0;
```

---

## 11. –ó–∞–ø—É—Å–∫ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
# 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone <repo>

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm install
cd backend && npm install

# 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
cp backend/.env.example backend/.env
# –ó–∞–ø–æ–ª–Ω–∏—Ç—å DATABASE_URL, JWT_SECRET

# 4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å–∏–¥–∏—Ä–æ–≤–∞—Ç—å
cd backend
npx prisma migrate dev
npx prisma db seed

# 5. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–µ–Ω–¥
npm run dev

# 6. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (–Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª)
cd ..
npm run dev
```

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# Frontend
npm run dev          # Dev server (Vite)
npm run build        # Production build
npm run test         # Vitest unit tests
npm run test:e2e     # Playwright E2E

# Backend
cd backend
npm run dev          # Nodemon + ts-node
npm run build        # TypeScript compile
npm run test         # Vitest tests
npx prisma studio    # Prisma Studio GUI
npx prisma migrate dev --name <name>  # –ù–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# backend/.env
DATABASE_URL="postgresql://user:pass@localhost:5432/waybills"
JWT_SECRET="your-secret-key"
JWT_EXPIRES_IN="15m"
REFRESH_TOKEN_EXPIRES_IN="7d"
PORT=3001
```

```env
# frontend/.env
VITE_API_URL="http://localhost:3001/api"
```

---

## 12. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã (Vitest)

```bash
# Frontend
npm run test

# Backend
cd backend && npm run test
```

–ü–æ–∫—Ä—ã—Ç–∏–µ:
- –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å (`isWinterDate`)
- –†–∞—Å—á—ë—Ç —Ç–æ–ø–ª–∏–≤–∞
- –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ —Ç–æ–ø–ª–∏–≤–∞
- State-–º–∞—à–∏–Ω—ã —Å—Ç–∞—Ç—É—Å–æ–≤

### E2E —Ç–µ—Å—Ç—ã (Playwright)

```bash
npm run test:e2e
npm run test:e2e:headed  # –° –±—Ä–∞—É–∑–µ—Ä–æ–º
npm run test:e2e:debug   # –û—Ç–ª–∞–¥–∫–∞
```

Golden-path —Ç–µ—Å—Ç:
1. –ë–ª–∞–Ω–∫–∏ ‚Üí –≤—ã–¥–∞—á–∞
2. –°–æ–∑–¥–∞–Ω–∏–µ –ü–õ
3. POSTED
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–ª–∞–¥–∞ + USED + audit

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ A: –¢–∏–ø—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã

### –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ Roles

| Role | –†—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ | –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∞ |
|------|------------------|----------------|
| `admin` | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä | –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø |
| `dispatcher` | –î–∏—Å–ø–µ—Ç—á–µ—Ä | import.limited, export.run |
| `driver` | –í–æ–¥–∏—Ç–µ–ª—å | –ü–õ: —Å–æ–∑–¥–∞–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∫–∞, –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ |
| `accountant` | –ë—É—Ö–≥–∞–ª—Ç–µ—Ä | waybill.post, audit.business.read |
| `mechanic` | –ú–µ—Ö–∞–Ω–∏–∫ | export.run, blanks.spoil.warehouse |
| `auditor` | –ê—É–¥–∏—Ç–æ—Ä | audit.read, audit.diff |
| `reviewer` | –ü—Ä–æ–≤–µ—Ä—è—é—â–∏–π | audit.business.read, waybill.submit |
| `viewer` | –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å | audit.read |

### –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

```typescript
type EmployeeType = 
  | 'driver'      // –í–æ–¥–∏—Ç–µ–ª—å
  | 'dispatcher'  // –î–∏—Å–ø–µ—Ç—á–µ—Ä
  | 'controller'  // –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä
  | 'accountant'  // –ë—É—Ö–≥–∞–ª—Ç–µ—Ä
  | 'mechanic'    // –ú–µ—Ö–∞–Ω–∏–∫
  | 'reviewer';   // –ü—Ä–æ–≤–µ—Ä—è—é—â–∏–π
```

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ B: –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ä–µ—Å—É—Ä—Å—ã

- **Prisma Studio:** `cd backend && npx prisma studio`
- **Swagger/OpenAPI:** (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- **–õ–æ–≥–∏:** `backend/logs/` + Pino pretty –≤ dev
- **Sentry:** –ù–∞—Å—Ç—Ä–æ–µ–Ω –≤ `sentry.config.ts`

---

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∞–∫—Ç—É–∞–ª–µ–Ω –Ω–∞ 28 –¥–µ–∫–∞–±—Ä—è 2025. –ü—Ä–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç.
