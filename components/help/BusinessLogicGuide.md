# Бизнес-логика приложения

Этот документ описывает все ключевые бизнес-процессы и правила, реализованные в системе. Основная часть логики находится в файле `services/mockApi.ts`.

## 1. Жизненный цикл Путевого листа (Waybill)

Это самая сложная и центральная бизнес-логика в приложении. Она управляет статусами путевого листа (ПЛ) и всеми связанными с этим побочными эффектами.

-   **Создание ПЛ (`addWaybill`):**
    *   При создании нового ПЛ, если ему присваивается номер бланка, этот бланк автоматически переводится в статус `"reserved"` (Зарезервирован), чтобы его не мог использовать кто-то другой.

-   **Изменение статуса (`changeWaybillStatus`):** Это ключевая функция, управляющая workflow.
    *   **Проведение (`DRAFT` → `POSTED`):**
        *   **Списание топлива с карты:** Если в ПЛ указана заправка (`fuelFilled > 0`), это количество топлива списывается с баланса топливной карты водителя (`fuelCardBalance` в `Employee`). Система проверяет, достаточно ли топлива на карте, и блокирует операцию в случае нехватки.
        *   **Списание бланка:** Бланк, связанный с ПЛ, переводится в статус `"used"` (Использован) и навсегда привязывается к этому ПЛ.
        *   **Автоматическое создание расхода:** Система может автоматически создать складскую операцию (`StockTransaction`) типа `expense` (расход) на фактическое потребление топлива по ПЛ.
    *   **Корректировка (`POSTED` → `DRAFT`):**
        *   **Возврат топлива на карту:** Если при проведении было списание за заправку, при корректировке это же количество топлива **возвращается** на баланс карты водителя.
        *   **Возврат бланка:** Статус бланка откатывается со статуса `"used"` на `"issued"` (Выдан), что теоретически позволяет использовать его повторно (хотя на практике это редкий сценарий).
        *   **Запись причины:** В поле `notes` путевого листа добавляется запись о том, кто, когда и по какой причине выполнил корректировку.
    *   **Отмена (`DRAFT` → `CANCELLED`):**
        *   Если бланк был зарезервирован под этот ПЛ, он освобождается и возвращается в статус `"issued"` (Выдан) водителю.

-   **Удаление ПЛ (`deleteWaybill`):**
    *   **Запрет удаления проведенных:** Проведенный (`POSTED`) ПЛ удалить нельзя. Сначала его нужно вернуть в черновики через "Корректировку".
    *   **Обработка бланка:** При удалении черновика система предлагает два варианта: пометить связанный бланк как `"spoiled"` (испорчен) или вернуть его водителю в статусе `"issued"` (Выдан).

## 2. Учет бланков строгой отчетности

Эта логика обеспечивает строгий контроль за движением бланков путевых листов.

-   **Пачки и бланки:** Система оперирует двумя сущностями: `WaybillBlankBatch` (пачка, описывающая диапазон номеров) и `WaybillBlank` (конкретный бланк с номером и статусом).
-   **Материализация (`materializeBatch`):** Администратор сначала создает "пачку" (например, серия "АА" с №1 по №100). Затем операция "материализации" создает в базе 100 отдельных записей для каждого бланка в статусе `"available"` (На складе).
-   **Выдача водителю (`issueBlanksToDriver`):** Бланки со статусом `"available"` можно выдать водителю. При этом их статус меняется на `"issued"` (Выдан), и им присваивается `ownerEmployeeId`.
-   **Списание (`spoilBlank`, `bulkSpoilBlanks`):** Бланки можно списать. Логика списания зависит от прав пользователя (`Capability`):
    *   `blanks.spoil.self`: Водитель может списать только свой бланк (статус `"issued"`).
    *   `blanks.spoil.warehouse`: Кладовщик может списать бланк со склада (статус `"available"`).
    *   `blanks.spoil.override`: Администратор может списать любой бланк, кроме уже использованного в проведенном ПЛ.

## 3. Складской учет и топливо

Эта логика отвечает за движение товаров на складе, особенно топлива.

-   **Движение остатков (`addStockTransaction`):**
    *   При создании документа типа `income` (Приход), остаток (`balance`) соответствующей номенклатуры (`GarageStockItem`) **увеличивается**.
    *   При создании документа типа `expense` (Расход), остаток **уменьшается**. Система проверяет, достаточно ли товара на складе, и блокирует операцию при нехватке.

-   **Пополнение топливных карт (`addStockTransaction` с `expenseReason: 'fuelCardTopUp'`):**
    *   Это особый тип расхода. При его создании остаток топлива на складе **уменьшается**, а баланс топливной карты водителя (`fuelCardBalance`) **увеличивается** на то же количество.

-   **Отмена операций (`deleteStockTransaction`):**
    *   **Логика реверсивна:** При удалении "Прихода" остаток на складе **уменьшается**. При удалении "Расхода" остаток **увеличивается**.
    *   **Отмена пополнения карты:** При удалении документа пополнения карты, остаток топлива на складе **увеличивается**, а баланс карты водителя **уменьшается**. Система проверяет, не уйдет ли баланс карты в минус, и если да — блокирует удаление.

## 4. Расчеты и валидация

Эта логика пронизывает все приложение и обеспечивает корректность вводимых данных.

-   **Расчет нормативного расхода топлива (`fuelPlanned` в ПЛ):**
    *   Система определяет, является ли дата ПЛ "зимней" или "летней" на основе настроек сезонов (`isWinterDate`).
    *   На основе этого выбирается базовая норма расхода из карточки ТС (`summerRate`/`winterRate`).
    *   Для каждого сегмента маршрута применяются повышающие коэффициенты (городской цикл, прогрев), если они включены в карточке ТС.
    *   Расход по всем сегментам суммируется для получения итогового нормативного расхода.

-   **Автозаполнение полей в ПЛ:**
    *   При выборе ТС система автоматически подставляет его текущий пробег и остаток топлива в поля "Пробег (выезд)" и "Топливо (выезд)".
    *   При выборе водителя автоматически подставляются закрепленные за ним диспетчер и контролер.

-   **Валидация данных:**
    *   **Frontend (Zod):** В формах используется `zod` для проверки форматов (ИНН, email), обязательных полей, диапазонов чисел и т.д.
    *   **Backend (mockApi):** На уровне "API" существуют проверки, которые невозможны на фронтенде. Например, проверка уникальности номера бланка, проверка остатков на складе или баланса топливной карты перед списанием.

## 5. Права доступа (RBAC)

Логика, определяющая, что может делать тот или иной пользователь, реализована в `services/auth.tsx`.

-   **Роли и Права:** Каждому пользователю присваивается `Role` (например, `admin`, `driver`). Каждой роли соответствует набор прав — `Capability` (например, `waybill.create`, `audit.rollback`).
-   **Проверка:** В компонентах используется хук `useAuth()` с функциями `can()` и `hasRole()` для условного отображения кнопок и разделов. На уровне `mockApi` также могут производиться проверки прав перед выполнением критических операций.

## 6. Импорт/Экспорт и Аудит

Логика, обеспечивающая переносимость данных и отслеживание изменений.

-   **Экспорт (`dumpAllDataForExport`):** Собирает все данные из всех "таблиц" в единый JSON-файл.
-   **Импорт (`Admin.tsx`):**
    *   Перед импортом всегда создается полная резервная копия текущей базы данных.
    *   Пользователь может выбрать стратегию слияния данных для каждой "таблицы" (перезапись, слияние, только добавление новых).
    *   В случае ошибки импорта, система может быть откачена из резервной копии.
-   **Аудит (`auditLog.ts`, `auditBusiness.ts`):**
    *   **Аудит импорта:** Каждая операция импорта подробно логируется, включая исходные и конечные значения каждой измененной записи. Это позволяет точечно откатывать изменения.
    *   **Бизнес-аудит:** Ключевые бизнес-события (создание ПЛ, проведение, списание бланка и т.д.) записываются в отдельный, более высокоуровневый журнал.