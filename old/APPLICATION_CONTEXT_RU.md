# КОНТЕКСТ ПРИЛОЖЕНИЯ: waybill-app

Этот документ представляет собой высокоуровневый обзор приложения "waybill-app", его назначения, архитектуры и ключевых функций.

## 1. Назначение и обзор приложения

"waybill-app" — это комплексная, мульти-арендная (multi-tenant) платформа для управления логистикой, разработанная для российского бизнеса. Её основная цель — оптимизация операций, связанных с путевыми листами, управлением транспортом и водителями, а также контролем складских запасов. Платформа обеспечивает соответствие актуальным российским нормативным требованиям, в частности, касающимся бланков строгой отчётности (БСО). Она представляет собой B2B SaaS-решение для логистического сектора.

## 2. Архитектура

Приложение использует клиент-серверную архитектуру с чётким разделением ответственности:

### 2.1. Фронтенд
*   **Стек технологий:** React 19, Vite (сборщик), Tailwind CSS (стилизация).
*   **Описание:** Современное одностраничное приложение (SPA), предоставляющее многофункциональный пользовательский интерфейс для взаимодействия с бэкенд-сервисами.

### 2.2. Бэкенд
*   **Стек технологий:** Node.js, Express.js (веб-фреймворк), TypeScript, Prisma ORM.
*   **Описание:** RESTful API сервер, отвечающий за бизнес-логику, сохранение данных и взаимодействие с внешними сервисами. Он предоставляет различные эндпоинты для управления ресурсами и процессами.
*   **Аутентификация:** Аутентификация на основе JWT с использованием bcrypt для хеширования паролей и надёжная система контроля доступа на основе ролей (RBAC) для управления правами пользователей.

### 2.3. База данных
*   **Технология:** PostgreSQL.
*   **Описание:** Реляционная база данных, используемая в качестве основного хранилища данных. Схема базы данных, определённая в `prisma/schema.prisma`, считается "источником истины" для бизнес-логики и модели данных приложения.

### 2.4. Режимы работы
Приложение поддерживает два режима:

- **Central Mode** — режим диспетчерской/офиса:
  - все данные берутся из backend API (Express + Prisma + PostgreSQL);
  - действуют полные правила аутентификации/авторизации и изоляции по организациям/подразделениям;
  - используется для управления ПЛ, БСО, складом, справочниками и отчётами.

- **Driver Mode** — облегчённый оффлайн‑режим:
  - данные хранятся локально в браузере (IndexedDB через LocalForage);
  - используется mockApi как локальный источник;
  - подходит для сценариев, когда backend недоступен или не требуется (например, водителю для локального учёта).

## 3. Ключевые функции

"waybill-app" предлагает широкий спектр функциональных возможностей для поддержки логистических операций:

*   **Управление жизненным циклом путевых листов:** Комплексные инструменты для создания, редактирования, отслеживания статуса и завершения путевых листов.
*   **Управление ресурсами:**
    *   **Транспортные средства:** Управление профилями транспортных средств, включая технические характеристики и назначения.
    *   **Водители:** Профили водителей, информация о лицензиях и их назначение на транспортные средства/путевые листы.
    *   **Сотрудники:** Общее управление сотрудниками.
*   **Контроль складских запасов:**
    *   **Номенклатура:** Учёт различных товарно-материальных ценностей, в частности, топлива.
    *   **Склады:** Управление местами хранения.
    *   **Движение товаров:** Регистрация и отслеживание поступлений и списаний.
*   **Создание маршрутов с помощью ИИ:**
    *   **Описание:** Интеграция с Google Gemini API, позволяющая пользователям генерировать маршруты с несколькими остановками из текстовых запросов на естественном языке (например, "из склада в пункт А, затем в пункт Б"). Это значительно упрощает планирование маршрутов и ввод данных.
    *   **Реализация:** Логика реализована на стороне клиента в файле `services/geminiService.ts`.
*   **Соответствие нормативным требованиям:**
    *   **Бланки строгой отчётности (БСО):** Специализированные модели данных (`Blank`, `BlankBatch`) для управления и учёта серийно нумерованных официальных бланков в соответствии с требованиями российского законодательства.
*   **Мульти-арендность:** Архитектура, позволяющая поддерживать несколько организаций с изолированными данными.
*   **Тестирование и верификация:**
    *   **Unit/Integration тесты**:
        *   на фронтенде: Vitest + Testing Library (доменные инварианты, компоненты, формы);
        *   на бэкенде: unit/интеграционные тесты для auth, ПЛ, склада.
    *   **E2E тесты**:
        *   Playwright используется для сквозных сценариев:
        *   логин → создание ПЛ → проведение → списание топлива со склада;
        *   цикл БСО: партия → выдача → использование в ПЛ;
        *   проверки разграничения доступа по ролям и подразделениям.

## 4. Важные файлы и каталоги

*   `package.json`: Зависимости и скрипты фронтенда (React, Vite, Tailwind, @google/generative-ai).
*   `backend/package.json`: Зависимости бэкенда (Express.js, Prisma, pg).
*   `backend/prisma/schema.prisma`: Основная схема базы данных, определяющая бизнес-логику.
*   `backend/src/routes/`: Определения эндпоинтов REST API бэкенда (например, `waybillRoutes.ts`, `vehicleRoutes.ts`).
*   `services/geminiService.ts`: Клиентская логика для интеграции с Google Gemini API (генерация маршрутов с помощью ИИ).
*   `App.tsx`: Основная точка входа для React-приложения, определяет структуру UI и маршрутизацию.

Этот документ обеспечивает базовое понимание приложения "waybill-app" для разработчиков, новых членов команды и всех, кто хочет быстро ознакомиться с системой.