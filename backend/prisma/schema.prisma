// ============================================================================
// Prisma Schema - Минимальные критичные исправления
// ============================================================================
// Версия: 2.1 (safe migration)
// Изменения от v2.0:
//   - UUID: uuid() вместо gen_random_uuid() (не требует pgcrypto)
//   - WaybillStatus: выровнен с frontend
//   - BlankStatus: выровнен с frontend
//   - onDelete: explicit Restrict/SetNull policies
// ============================================================================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// ENUMS - Выровнены с frontend types.ts
// ============================================================================

enum StockMovementType {
  INCOME
  EXPENSE
  ADJUSTMENT
  TRANSFER  // REL-102: перемещение между локациями
}

/// Выровнено с frontend: AVAILABLE вместо FREE, добавлены RESERVED/RETURNED
enum BlankStatus {
  AVAILABLE // было: FREE
  ISSUED
  RESERVED // добавлено
  USED
  RETURNED // добавлено
  SPOILED // было: DAMAGED/LOST
}

/// Выровнено с frontend: SUBMITTED вместо APPROVED, POSTED вместо COMPLETED
enum WaybillStatus {
  DRAFT
  SUBMITTED // было: APPROVED
  POSTED // было: COMPLETED/IN_PROGRESS/ISSUED
  CANCELLED
}

enum FuelCalculationMethod {
  BOILER
  MIXED
  SEGMENTS
}

enum AuditActionType {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  LOGIN
  LOGOUT
}

// FUEL-001: Fuel Card Transaction and TopUp enums
enum FuelCardTransactionType {
  TOPUP
  ADJUSTMENT
  DEBIT
}

enum TopUpScheduleType {
  DAILY
  WEEKLY
  MONTHLY
}

// REL-101: Stock Location Types
enum StockLocationType {
  WAREHOUSE
  FUEL_CARD
  VEHICLE_TANK
}

// REL-105: Fuel Card Reset Enums
enum ResetFrequency {
  MONTHLY
  QUARTERLY
  YEARLY
  MANUAL
}

enum ResetMode {
  TRANSFER_TO_WAREHOUSE  // вернуть остатки в поол
  EXPIRE_EXPENSE         // сгорание/списание
}

enum ResetScope {
  ALL_CARDS       // все карты организации
  BY_PROVIDER     // по поставщику
  BY_DEPARTMENT   // по подразделению
  SPECIFIC_CARDS  // конкретный список
}

// REL-201: Stock Item Category for unified nomenclature
enum StockItemCategory {
  FUEL
  MATERIAL
  SPARE_PART
  SERVICE
  OTHER
}

// ============================================================================
// ОРГАНИЗАЦИИ И ПОДРАЗДЕЛЕНИЯ
// ============================================================================

model Organization {
  id        String   @id @default(uuid()) @db.Uuid // Изменено: uuid() вместо gen_random_uuid()
  name      String   @db.Text  // Deprecated, use shortName
  shortName String?  @db.Text
  fullName  String?  @db.Text
  inn       String?  @db.VarChar(12)
  kpp       String?  @db.VarChar(9)
  ogrn      String?  @db.VarChar(15)
  address   String?  @db.Text
  registrationDate String? @db.Text
  contactPerson String? @db.Text
  phone     String?  @db.Text
  email     String?  @db.Text
  bankAccount String? @db.Text
  bankName  String?  @db.Text
  bankBik   String?  @db.VarChar(9)
  correspondentAccount String? @db.Text
  accountCurrency String? @db.Text
  paymentPurpose String? @db.Text
  status    String   @default("Active") @db.Text
  group     String?  @db.Text
  notes     String?  @db.Text
  medicalLicenseNumber String? @db.Text
  medicalLicenseIssueDate String? @db.Text
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(6)
  stockLockedAt DateTime? @db.Timestamp(6) // P0-4: STOCK-PERIOD-LOCK
  isOwn         Boolean  @default(false)   // OWN-ORG-001: Собственная организация

  departments    Department[]
  users          User[]
  employees      Employee[]
  vehicles       Vehicle[]
  fuelCards      FuelCard[]
  stockItems     StockItem[]
  warehouses     Warehouse[]
  blankBatches   BlankBatch[]
  blanks         Blank[]
  waybills       Waybill[]
  stockMovements StockMovement[]
  stockLocations StockLocation[]
  auditLogs      AuditLog[]
  resetRules     FuelCardResetRule[]  // REL-105

  @@index([isOwn])
  @@map("organizations")
}

model Department {
  id                 String   @id @default(uuid()) @db.Uuid
  organizationId     String   @db.Uuid
  code               String?  @db.Text
  name               String   @db.Text
  address            String?  @db.Text
  defaultWarehouseId String?  @db.Uuid  // WH-DEC-001: Default warehouse for stock movements
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  updatedAt          DateTime @default(now()) @updatedAt @db.Timestamp(6)

  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  defaultWarehouse Warehouse?   @relation("DefaultWarehouse", fields: [defaultWarehouseId], references: [id], onDelete: SetNull)
  users            User[]
  employees        Employee[]
  vehicles         Vehicle[]
  warehouses       Warehouse[]
  blankBatches     BlankBatch[]
  blanks           Blank[]
  waybills         Waybill[]
  stockLocations   StockLocation[]
  stockItems       StockItem[]  // REL-201
  resetRulesForDept FuelCardResetRule[] @relation("ResetRuleDepartment")  // REL-105

  // WB-PREFILL-010: Default personnel
  defaultDispatcherEmployeeId String? @db.Uuid
  defaultControllerEmployeeId String? @db.Uuid
  defaultDispatcher           Employee? @relation("DeptDefaultDispatcher", fields: [defaultDispatcherEmployeeId], references: [id], onDelete: SetNull)
  defaultController           Employee? @relation("DeptDefaultController", fields: [defaultControllerEmployeeId], references: [id], onDelete: SetNull)

  @@map("departments")
}

// ============================================================================
// ПОЛЬЗОВАТЕЛИ И RBAC
// ============================================================================

model User {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @db.Uuid
  departmentId   String?  @db.Uuid
  email          String   @unique @db.Text
  passwordHash   String   @db.Text
  fullName       String   @db.Text
  isActive       Boolean  @default(true)
  isSystem       Boolean  @default(false)  // System users cannot be deleted
  tokenVersion   Int      @default(0)      // AUTH-003: для немедленной инвалидации access token
  createdAt      DateTime @default(now()) @db.Timestamp(6)
  updatedAt      DateTime @default(now()) @updatedAt @db.Timestamp(6)
  employeeId     String?  @unique @db.Uuid

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  department   Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  employee     Employee?    @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  roles                 UserRole[]
  createdWaybills       Waybill[]       @relation("WaybillCreatedBy")
  approvedWaybills      Waybill[]       @relation("WaybillApprovedBy")
  completedWaybills     Waybill[]       @relation("WaybillCompletedBy")
  createdStockMovements StockMovement[] @relation("StockMovementCreatedBy")
  voidedStockMovements  StockMovement[] @relation("StockMovementVoidedBy")  // P1-1: STOCK-VOID
  createdBlankBatches   BlankBatch[]
  auditLogs             AuditLog[]
  refreshTokens         RefreshToken[]
  fuelCardTransactions  FuelCardTransaction[] @relation("FuelCardTransactionCreatedBy") // FUEL-001

  @@map("users")
}

model Role {
  id          String  @id @default(uuid()) @db.Uuid
  code        String  @unique @db.Text
  name        String  @db.Text
  description String? @db.Text

  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@map("roles")
}

model Permission {
  id          String  @id @default(uuid()) @db.Uuid
  code        String  @unique @db.Text
  description String? @db.Text

  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String @db.Uuid
  permissionId String @db.Uuid

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  userId String @db.Uuid
  roleId String @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

// ============================================================================
// СОТРУДНИКИ И ВОДИТЕЛИ
// ============================================================================

model Employee {
  id                           String    @id @default(uuid()) @db.Uuid
  organizationId               String    @db.Uuid
  departmentId                 String?   @db.Uuid
  
  fullName                     String    @db.Text
  shortName                    String?   @db.Text
  employeeType                 String    @default("driver") @db.Text  // driver, dispatcher, controller, etc.
  position                     String?   @db.Text
  status                       String    @default("Active") @db.Text  // Active, Inactive
  
  phone                        String?   @db.Text
  address                      String?   @db.Text
  email                        String?   @db.Text
  dateOfBirth                  String?   @db.Text  // stored as string in frontend
  
  personnelNumber              String?   @db.Text
  snils                        String?   @db.Text
  
  licenseCategory              String?   @db.Text
  documentNumber               String?   @db.Text
  documentExpiry               String?   @db.Text  // date as string
  
  medicalCertificateSeries     String?   @db.Text
  medicalCertificateNumber     String?   @db.Text
  medicalCertificateIssueDate  String?   @db.Text  // date as string
  medicalCertificateExpiryDate String?   @db.Text  // date as string
  medicalInstitutionId         String?   @db.Uuid
  
  driverCardType               String?   @db.Text
  driverCardNumber             String?   @db.Text
  driverCardStartDate          String?   @db.Text  // date as string
  driverCardExpiryDate         String?   @db.Text  // date as string
  
  fuelCardNumber               String?   @db.Text
  fuelCardBalance              Float     @default(0) @db.DoublePrecision
  
  dispatcherId                 String?   @db.Uuid
  controllerId                 String?   @db.Uuid
  
  notes                        String?   @db.Text
  isActive                     Boolean   @default(true)
  
  assignedVehicles Vehicle[] @relation("VehicleDriver")
  
  createdAt                    DateTime  @default(now()) @db.Timestamp(6)
  updatedAt                    DateTime  @default(now()) @updatedAt @db.Timestamp(6)

  organization         Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department           Department?   @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  dispatcher           Employee?     @relation("EmployeeDispatcher", fields: [dispatcherId], references: [id], onDelete: SetNull)
  controller           Employee?     @relation("EmployeeController", fields: [controllerId], references: [id], onDelete: SetNull)
  
  assignedDrivers      Employee[]    @relation("EmployeeDispatcher")
  controlledEmployees  Employee[]    @relation("EmployeeController")
  driver               Driver?
  user                 User?

  // WB-PREFILL-010: Back-relations
  waybillsAsDispatcher Waybill[] @relation("WaybillDispatcher")
  waybillsAsController Waybill[] @relation("WaybillController")
  
  defaultForDispatcherDepartments Department[] @relation("DeptDefaultDispatcher")
  defaultForControllerDepartments Department[] @relation("DeptDefaultController")
  
  // WH-FIX-RESP-LOC-001: Back-relation for warehouse responsible
  responsibleForWarehouses Warehouse[] @relation("WarehouseResponsible")

  @@map("employees")
}

model Driver {
  id              String    @id @default(uuid()) @db.Uuid
  employeeId      String    @unique @db.Uuid
  licenseNumber   String    @db.Text
  licenseCategory String?   @db.Text
  licenseValidTo  DateTime? @db.Date
  createdAt       DateTime  @default(now()) @db.Timestamp(6)
  updatedAt       DateTime  @default(now()) @updatedAt @db.Timestamp(6)

  employee     Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  waybills     Waybill[]
  fuelCards    FuelCard[] @relation("FuelCardDriver")
  blanksIssued Blank[]    @relation("BlankIssuedToDriver")
  cardAssignments FuelCardAssignment[] @relation("AssignmentDriver")  // REL-106

  @@map("drivers")
}

// ============================================================================
// ТРАНСПОРТ И ТОПЛИВНЫЕ КАРТЫ
// ============================================================================

model Vehicle {
  id                 String   @id @default(uuid()) @db.Uuid
  organizationId     String   @db.Uuid
  departmentId       String?  @db.Uuid
  code               String?  @db.Text
  registrationNumber String   @unique @db.Text
  brand              String?  @db.Text
  model              String?  @db.Text
  vin                String?  @db.Text
  fuelType           String?  @db.Text   /// @deprecated REL-202: Use fuelStockItemId
  fuelTypeId         String?  @db.Uuid   /// @deprecated REL-202: Use fuelStockItemId
  fuelTankCapacity   Decimal? @db.Decimal(10, 2)
  mileage            Decimal  @default(0) @db.Decimal(10, 1) // Added
  currentFuel        Decimal  @default(0) @db.Decimal(10, 2) // Added
  fuelConsumptionRates Json? // Added: { winterRate, summerRate, cityIncreasePercent, warmingIncreasePercent }
  
  year               Int?
  vehicleType        String?  @db.Text
  assignedDriverId   String?  @db.Uuid
  
  ptsType            String?  @db.Text
  ptsSeries          String?  @db.Text
  ptsNumber          String?  @db.Text
  eptsNumber         String?  @db.Text
  
  diagnosticCardNumber     String?  @db.Text
  diagnosticCardIssueDate  String?  @db.Text
  diagnosticCardExpiryDate String?  @db.Text
  
  maintenanceHistory Json?
  
  useCityModifier    Boolean  @default(false)
  useWarmingModifier Boolean  @default(false)
  
  osagoSeries        String?  @db.Text
  osagoNumber        String?  @db.Text
  osagoStartDate     String?  @db.Text
  osagoEndDate       String?  @db.Text
  
  // REL-200: New reference to StockItem (will replace fuelTypeId)
  fuelStockItemId    String?  @db.Uuid
  
  storageLocationId  String?  @db.Uuid
  notes              String?  @db.Text
  disableFuelCapacityCheck Boolean @default(false)

  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  updatedAt          DateTime @default(now()) @updatedAt @db.Timestamp(6)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  department   Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  assignedDriver  Employee?  @relation("VehicleDriver", fields: [assignedDriverId], references: [id], onDelete: SetNull)
  fuelTypeRelation FuelType? @relation(fields: [fuelTypeId], references: [id], onDelete: SetNull)
  fuelStockItem    StockItem? @relation("VehicleFuelStockItem", fields: [fuelStockItemId], references: [id], onDelete: SetNull)  // REL-200
  storageLocation Warehouse? @relation(fields: [storageLocationId], references: [id], onDelete: SetNull)

  waybills     Waybill[]
  fuelCards    FuelCard[]   @relation("FuelCardVehicle")
  blanksIssued Blank[]      @relation("BlankIssuedToVehicle")
  stockLocation StockLocation? @relation("VehicleTankLocation")
  cardAssignments FuelCardAssignment[] @relation("AssignmentVehicle")  // REL-106

  @@map("vehicles")
}

model FuelCard {
  id                  String   @id @default(uuid()) @db.Uuid
  organizationId      String   @db.Uuid
  cardNumber          String   @unique @db.Text
  provider            String?  @db.Text
  isActive            Boolean  @default(true)
  assignedToDriverId  String?  @db.Uuid
  assignedToVehicleId String?  @db.Uuid
  balanceLiters       Decimal  @default(0) @db.Decimal(14, 3) // FUEL-001: литровый баланс
  createdAt           DateTime @default(now()) @db.Timestamp(6)
  updatedAt           DateTime @default(now()) @updatedAt @db.Timestamp(6)

  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedToDriver  Driver?      @relation("FuelCardDriver", fields: [assignedToDriverId], references: [id], onDelete: SetNull)
  assignedToVehicle Vehicle?     @relation("FuelCardVehicle", fields: [assignedToVehicleId], references: [id], onDelete: SetNull)
  waybills          Waybill[]
  transactions      FuelCardTransaction[] // FUEL-001
  topUpRules        FuelCardTopUpRule[]   // FUEL-001
  stockLocation     StockLocation? @relation("FuelCardLocation")
  assignments       FuelCardAssignment[]  // REL-106

  @@map("fuel_cards")
}

/// REL-106: История назначений топливных карт
model FuelCardAssignment {
  id             String    @id @default(uuid()) @db.Uuid
  fuelCardId     String    @db.Uuid
  
  // Период действия
  validFrom      DateTime  @db.Timestamp(6)  // начало действия
  validTo        DateTime? @db.Timestamp(6)  // конец действия (null = бессрочно)
  
  // Назначение
  driverId       String?   @db.Uuid
  vehicleId      String?   @db.Uuid
  
  // Дополнительная информация
  providerName   String?   @db.Text  // имя поставщика на момент назначения
  comment        String?   @db.Text
  
  createdAt      DateTime  @default(now()) @db.Timestamp(6)
  updatedAt      DateTime  @default(now()) @updatedAt @db.Timestamp(6)

  fuelCard       FuelCard  @relation(fields: [fuelCardId], references: [id], onDelete: Cascade)
  driver         Driver?   @relation("AssignmentDriver", fields: [driverId], references: [id], onDelete: SetNull)
  vehicle        Vehicle?  @relation("AssignmentVehicle", fields: [vehicleId], references: [id], onDelete: SetNull)

  @@index([fuelCardId, validFrom, validTo])
  @@index([driverId, validFrom, validTo])
  @@map("fuel_card_assignments")
}

// ============================================================================
// СКЛАДСКОЙ УЧЁТ
// ============================================================================

model StockItem {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @db.Uuid
  departmentId   String?  @db.Uuid  // REL-201: привязка к подразделению
  code           String?  @db.Text  // артикул
  name           String   @db.Text
  unit           String   @default("л") @db.Text
  
  // REL-201: Use enum instead of string for category
  categoryEnum   StockItemCategory?  // FUEL, MATERIAL, SPARE_PART, SERVICE, OTHER
  
  isFuel         Boolean  @default(false)  // Kept for backward compatibility
  balance        Decimal  @default(0) @db.Decimal(14, 3)
  isActive       Boolean  @default(true)
  
  // REL-200/201: Fields for fuel
  density        Float?   @db.DoublePrecision  // плотность для топлива (кг/л)
  category       String?  @db.Text             // Deprecated: use categoryEnum
  fuelTypeLegacyId String?  @unique @db.Uuid   // REL-201: для миграции со старого FuelType
  
  createdAt      DateTime @default(now()) @db.Timestamp(6)
  updatedAt      DateTime @default(now()) @updatedAt @db.Timestamp(6)

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department     Department?     @relation(fields: [departmentId], references: [id], onDelete: SetNull)  // REL-201
  fuelType       FuelType?       @relation(fields: [fuelTypeLegacyId], references: [id], onDelete: SetNull)
  stockMovements StockMovement[]
  waybillFuel    WaybillFuel[]
  topUpRules     FuelCardTopUpRule[] @relation("TopUpRuleStockItem")
  resetRules     FuelCardResetRule[] @relation("ResetRuleStockItem")
  vehicles       Vehicle[]       @relation("VehicleFuelStockItem")

  @@unique([organizationId, name])  // REL-201: уникальность по орг + имени
  @@index([organizationId, categoryEnum])  // REL-201
  @@map("stock_items")
}

model Warehouse {
  id                    String   @id @default(uuid()) @db.Uuid
  organizationId        String   @db.Uuid
  departmentId          String?  @db.Uuid
  name                  String   @db.Text
  address               String?  @db.Text
  // WH-FIX-RESP-LOC-001: New fields
  responsibleEmployeeId String?  @db.Uuid
  description           String?  @db.Text
  type                  String?  @db.Text  // centralWarehouse, remoteWarehouse, vehicleTank, contractorWarehouse
  status                String   @default("active") @db.Text  // active, archived
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @default(now()) @updatedAt @db.Timestamp(6)

  organization          Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department            Department?     @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  responsibleEmployee   Employee?       @relation("WarehouseResponsible", fields: [responsibleEmployeeId], references: [id], onDelete: SetNull)
  defaultForDepartments Department[]    @relation("DefaultWarehouse") // WH-DEC-001
  stockMovements        StockMovement[]
  vehicles              Vehicle[]
  stockLocation         StockLocation? @relation("WarehouseLocation")

  @@index([organizationId, responsibleEmployeeId])
  @@map("warehouses")
}

/// @deprecated REL-200: Use StockItem with isFuel=true and category="FUEL" instead
model FuelType {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)  // AI-92, DT
  name        String   @db.Text                  // Бензин АИ-92
  density     Float?   @db.DoublePrecision       // плотность
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @db.Timestamp(6)
  
  waybillFuels WaybillFuel[]
  vehicles     Vehicle[]
  stockItems   StockItem[]  // REL-200: обратная связь для миграции
  
  @@map("fuel_types")
}

model Route {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @db.Text              // "Москва - Санкт-Петербург"
  startPoint      String?  @db.Text
  endPoint        String?  @db.Text
  distance        Float?   @db.DoublePrecision   // км
  estimatedTime   Int?                           // минуты
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @updatedAt @db.Timestamp(6)
  
  waybillRoutes WaybillRoute[]
  
  @@map("routes")
}

model StockMovement {
  id              String            @id @default(uuid()) @db.Uuid
  organizationId  String            @db.Uuid
  warehouseId     String?           @db.Uuid  // deprecated: сохранено для обратной совместимости
  stockItemId     String            @db.Uuid
  movementType    StockMovementType
  quantity        Decimal           @db.Decimal(14, 3)
  
  // REL-102: Location support
  stockLocationId     String?       @db.Uuid  // локация для INCOME/EXPENSE/ADJUSTMENT
  fromStockLocationId String?       @db.Uuid  // источник для TRANSFER
  toStockLocationId   String?       @db.Uuid  // назначение для TRANSFER
  
  // REL-102: Temporal support
  occurredAt      DateTime          @default(now()) @db.Timestamp(6)  // когда произошла операция
  occurredSeq     Int               @default(0)  // порядок в пределах одного occurredAt
  
  documentType    String?           @db.Text
  documentId      String?           @db.Uuid
  externalRef     String?           @db.Text  // REL-102: для идемпотентности (TOPUP:ruleId:date)
  comment         String?           @db.Text
  createdByUserId String?           @db.Uuid
  createdAt       DateTime          @default(now()) @db.Timestamp(6)
  
  // P1-1: STOCK-VOID — Soft void support
  isVoid          Boolean           @default(false)
  voidedAt        DateTime?         @db.Timestamp(6)
  voidedByUserId  String?           @db.Uuid
  voidReason      String?           @db.Text

  organization      Organization   @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  warehouse         Warehouse?     @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  stockItem         StockItem      @relation(fields: [stockItemId], references: [id], onDelete: Restrict)
  stockLocation     StockLocation? @relation("LocationMovements", fields: [stockLocationId], references: [id], onDelete: SetNull)
  fromStockLocation StockLocation? @relation("FromLocationTransfers", fields: [fromStockLocationId], references: [id], onDelete: SetNull)
  toStockLocation   StockLocation? @relation("ToLocationTransfers", fields: [toStockLocationId], references: [id], onDelete: SetNull)
  createdByUser     User?          @relation("StockMovementCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  voidedByUser      User?          @relation("StockMovementVoidedBy", fields: [voidedByUserId], references: [id], onDelete: SetNull)

  @@unique([organizationId, externalRef])
  @@index([stockLocationId, stockItemId, occurredAt])
  @@index([fromStockLocationId, stockItemId, occurredAt])
  @@index([toStockLocationId, stockItemId, occurredAt])
  @@index([organizationId, isVoid, occurredAt])  // P1-1: for filtering out voided movements
  @@map("stock_movements")
}

// REL-101: Универсальные локации хранения топлива и ТМЦ
model StockLocation {
  id             String            @id @default(uuid()) @db.Uuid
  organizationId String            @db.Uuid
  departmentId   String?           @db.Uuid
  type           StockLocationType
  name           String            @db.Text
  
  // Привязки (одна из них заполнена в зависимости от type)
  warehouseId    String?           @unique @db.Uuid
  fuelCardId     String?           @unique @db.Uuid
  vehicleId      String?           @unique @db.Uuid
  
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now()) @db.Timestamp(6)
  updatedAt      DateTime          @default(now()) @updatedAt @db.Timestamp(6)

  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department     Department?       @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  warehouse      Warehouse?        @relation("WarehouseLocation", fields: [warehouseId], references: [id], onDelete: Cascade)
  fuelCard       FuelCard?         @relation("FuelCardLocation", fields: [fuelCardId], references: [id], onDelete: Cascade)
  vehicle        Vehicle?          @relation("VehicleTankLocation", fields: [vehicleId], references: [id], onDelete: Cascade)
  
  // REL-102: Обратные связи для движений
  movements      StockMovement[]   @relation("LocationMovements")
  transfersFrom  StockMovement[]   @relation("FromLocationTransfers")
  transfersTo    StockMovement[]   @relation("ToLocationTransfers")
  
  // REL-104: Обратные связи для правил пополнения
  topUpRulesAsSource FuelCardTopUpRule[] @relation("TopUpRuleSource")
  
  // REL-105: Обратные связи для правил обнуления
  resetRulesAsTarget FuelCardResetRule[] @relation("ResetRuleTarget")

  @@index([organizationId, type])
  @@map("stock_locations")
}

// ============================================================================
// БЛАНКИ БСО
// ============================================================================

model BlankBatch {
  id              String   @id @default(uuid()) @db.Uuid
  organizationId  String   @db.Uuid
  departmentId    String?  @db.Uuid
  series          String?  @db.Text
  numberFrom      Int
  numberTo        Int
  createdByUserId String?  @db.Uuid
  createdAt       DateTime @default(now()) @db.Timestamp(6)

  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department    Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  createdByUser User?        @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  blanks        Blank[]

  @@map("blank_batches")
}

model Blank {
  id                String      @id @default(uuid()) @db.Uuid
  organizationId    String      @db.Uuid
  departmentId      String?     @db.Uuid
  batchId           String?     @db.Uuid
  series            String?     @db.Text
  number            Int
  status            BlankStatus @default(AVAILABLE) // Изменено: AVAILABLE вместо FREE
  issuedToDriverId  String?     @db.Uuid
  issuedToVehicleId String?     @db.Uuid
  issuedAt          DateTime?   @db.Timestamp(6)
  usedAt            DateTime?   @db.Timestamp(6)
  damagedReason     String?     @db.Text
  createdAt         DateTime    @default(now()) @db.Timestamp(6)
  updatedAt         DateTime    @default(now()) @updatedAt @db.Timestamp(6)

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  department      Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  batch           BlankBatch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)
  issuedToDriver  Driver?      @relation("BlankIssuedToDriver", fields: [issuedToDriverId], references: [id], onDelete: SetNull)
  issuedToVehicle Vehicle?     @relation("BlankIssuedToVehicle", fields: [issuedToVehicleId], references: [id], onDelete: SetNull)
  waybills        Waybill[]

  @@unique([organizationId, series, number])
  @@index([organizationId, issuedToDriverId, status, series, number]) // Added BLS-101
  @@map("blanks")
}

// ============================================================================
// ПУТЕВЫЕ ЛИСТЫ
// ============================================================================

model Waybill {
  id                String        @id @default(uuid()) @db.Uuid
  organizationId    String        @db.Uuid
  departmentId      String?       @db.Uuid
  number            String        @db.Text
  date              DateTime      @db.Date
  vehicleId         String        @db.Uuid
  driverId          String        @db.Uuid
  fuelCardId        String?       @db.Uuid
  blankId           String?       @unique @db.Uuid
  status            WaybillStatus @default(DRAFT) // Enum выровнен с frontend
  odometerStart     Decimal?      @db.Decimal(10, 1)
  odometerEnd       Decimal?      @db.Decimal(10, 1)
  plannedRoute      String?       @db.Text
  notes             String?       @db.Text
  isCityDriving     Boolean       @default(false) // Added WB-102
  isWarming         Boolean       @default(false) // Added WB-102
  fuelCalculationMethod FuelCalculationMethod @default(BOILER)
  
  // REL-103: Время начала и окончания рейса
  startAt           DateTime?     @db.Timestamp(6)  // время выезда
  endAt             DateTime?     @db.Timestamp(6)  // время возврата
  
  // WB-FIX-PL-001: Ответственные и срок действия
  dispatcherEmployeeId String?    @db.Uuid
  controllerEmployeeId String?    @db.Uuid
  validTo              DateTime?  @db.Timestamp(6)
  
  createdByUserId   String?       @db.Uuid
  approvedByUserId  String?       @db.Uuid
  completedByUserId String?       @db.Uuid
  createdAt         DateTime      @default(now()) @db.Timestamp(6)
  updatedAt         DateTime      @default(now()) @updatedAt @db.Timestamp(6)

  // Изменено: explicit onDelete policies
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  department      Department?  @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  vehicle         Vehicle      @relation(fields: [vehicleId], references: [id], onDelete: Restrict)
  driver          Driver       @relation(fields: [driverId], references: [id], onDelete: Restrict)
  fuelCard        FuelCard?    @relation(fields: [fuelCardId], references: [id], onDelete: SetNull)
  blank           Blank?       @relation(fields: [blankId], references: [id], onDelete: SetNull)
  createdByUser   User?        @relation("WaybillCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  approvedByUser  User?        @relation("WaybillApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  completedByUser User?        @relation("WaybillCompletedBy", fields: [completedByUserId], references: [id], onDelete: SetNull)
  
  dispatcherEmployee Employee? @relation("WaybillDispatcher", fields: [dispatcherEmployeeId], references: [id], onDelete: SetNull)
  controllerEmployee Employee? @relation("WaybillController", fields: [controllerEmployeeId], references: [id], onDelete: SetNull)
  
  routes    WaybillRoute[]
  fuelLines WaybillFuel[]

  @@unique([organizationId, departmentId, number, date])
  @@map("waybills")
}

model WaybillRoute {
  id          String   @id @default(uuid()) @db.Uuid
  waybillId   String   @db.Uuid
  routeId     String?  @db.Uuid
  legOrder    Int
  fromPoint   String?  @db.Text
  toPoint     String?  @db.Text
  distanceKm  Decimal? @db.Decimal(10, 2)
  plannedTime String?  @db.Text
  actualTime  String?  @db.Text
  comment     String?  @db.Text
  isCityDriving Boolean?
  isWarming     Boolean?
  date        DateTime? @db.Date  // Added: route-specific date for multi-day waybills

  waybill Waybill @relation(fields: [waybillId], references: [id], onDelete: Cascade)
  route   Route?  @relation(fields: [routeId], references: [id], onDelete: SetNull)

  @@map("waybill_routes")
}

model WaybillFuel {
  id           String   @id @default(uuid()) @db.Uuid
  waybillId    String   @db.Uuid
  stockItemId  String   @db.Uuid  // REL-202: Primary FK for stock movements
  fuelTypeId   String?  @db.Uuid  /// @deprecated REL-202: Use stockItemId instead
  fuelStart    Decimal? @db.Decimal(10, 2)
  fuelReceived Decimal? @db.Decimal(10, 2)
  fuelConsumed Decimal? @db.Decimal(10, 2)
  fuelEnd      Decimal? @db.Decimal(10, 2)
  fuelPlanned  Decimal? @db.Decimal(10, 2) // Added WB-102
  
  // REL-103: Время и источник заправки
  refueledAt   DateTime? @db.Timestamp(6)  // время заправки
  sourceType   String?   @db.Text          // "FUEL_CARD" | "WAREHOUSE"
  
  comment      String?  @db.Text

  waybill   Waybill    @relation(fields: [waybillId], references: [id], onDelete: Cascade)
  stockItem StockItem  @relation(fields: [stockItemId], references: [id], onDelete: Restrict)
  fuelType  FuelType?  @relation(fields: [fuelTypeId], references: [id], onDelete: SetNull)

  @@map("waybill_fuel")
}

// ============================================================================
// АУДИТ И АУТЕНТИФИКАЦИЯ
// ============================================================================

model AuditLog {
  id             String          @id @default(uuid()) @db.Uuid
  organizationId String?         @db.Uuid
  userId         String?         @db.Uuid
  actionType     AuditActionType
  entityType     String          @db.Text
  entityId       String?         @db.Uuid
  description    String?         @db.Text
  oldValue       Json?
  newValue       Json?
  createdAt      DateTime        @default(now()) @db.Timestamp(6)

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_log")
}

model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  tokenHash String    @db.Text
  createdAt DateTime  @default(now()) @db.Timestamp(6)
  expiresAt DateTime  @db.Timestamp(6)
  revokedAt DateTime? @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

/// Настройки приложения (key-value с JSON значением)
model Setting {
  key       String   @id
  value     Json
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@map("settings")
}

model CalendarEvent {
  id        String   @id @default(uuid()) @db.Uuid
  date      String   @unique // YYYY-MM-DD
  type      String   // holiday, workday, short
  note      String?
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@map("calendar_events")
}

// ============================================================================
// FUEL CARD TRANSACTIONS & AUTO TOP-UP (FUEL-001)
// ============================================================================

/// Ledger для истории пополнений/корректировок топливной карты
model FuelCardTransaction {
  id              String                  @id @default(uuid()) @db.Uuid
  organizationId  String                  @db.Uuid
  fuelCardId      String                  @db.Uuid
  type            FuelCardTransactionType
  amountLiters    Decimal                 @db.Decimal(14, 3)
  reason          String?                 @db.Text
  periodKey       String?                 @db.Text // для авто-пополнения (например 2025-12, 2025-W51, 2025-12-19)
  createdByUserId String?                 @db.Uuid
  createdAt       DateTime                @default(now()) @db.Timestamp(6)

  fuelCard        FuelCard @relation(fields: [fuelCardId], references: [id], onDelete: Cascade)
  createdByUser   User?    @relation("FuelCardTransactionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  // Идемпотентность авто-пополнений: один TOPUP на период
  @@unique([organizationId, fuelCardId, type, periodKey])
  @@index([organizationId, fuelCardId, createdAt])
  @@map("fuel_card_transactions")
}

/// Правила автопополнения топливной карты
model FuelCardTopUpRule {
  id               String            @id @default(uuid()) @db.Uuid
  organizationId   String            @db.Uuid
  fuelCardId       String            @db.Uuid
  isActive         Boolean           @default(true)
  scheduleType     TopUpScheduleType
  amountLiters     Decimal           @db.Decimal(14, 3)
  minBalanceLiters Decimal?          @db.Decimal(14, 3) // если задано — пополняем только при балансе < порога
  timezone         String            @default("Europe/Moscow") @db.Text
  nextRunAt        DateTime
  lastRunAt        DateTime?
  
  // REL-104: Для интеграции с StockMovement TRANSFER
  stockItemId      String?           @db.Uuid  // какой тип топлива (номенклатура)
  sourceLocationId String?           @db.Uuid  // откуда брать (обычно склад)
  
  createdAt        DateTime          @default(now()) @db.Timestamp(6)
  updatedAt        DateTime          @default(now()) @updatedAt @db.Timestamp(6)

  fuelCard         FuelCard       @relation(fields: [fuelCardId], references: [id], onDelete: Cascade)
  stockItem        StockItem?     @relation("TopUpRuleStockItem", fields: [stockItemId], references: [id], onDelete: SetNull)
  sourceLocation   StockLocation? @relation("TopUpRuleSource", fields: [sourceLocationId], references: [id], onDelete: SetNull)

  @@index([organizationId, isActive, nextRunAt])
  @@map("fuel_card_topup_rules")
}

/// REL-105: Правила обнуления топливных карт
model FuelCardResetRule {
  id               String          @id @default(uuid()) @db.Uuid
  organizationId   String          @db.Uuid
  name             String          @db.Text  // название правила
  isActive         Boolean         @default(true)
  
  // Параметры расписания
  frequency        ResetFrequency
  nextRunAt        DateTime?       @db.Timestamp(6)
  lastRunAt        DateTime?       @db.Timestamp(6)
  
  // Область действия
  scope            ResetScope      @default(ALL_CARDS)
  providerFilter   String?         @db.Text  // для BY_PROVIDER
  departmentId     String?         @db.Uuid  // для BY_DEPARTMENT
  cardIds          String[]        @db.Uuid  // для SPECIFIC_CARDS
  
  // Режим обнуления
  mode             ResetMode       @default(EXPIRE_EXPENSE)
  targetLocationId String?         @db.Uuid  // куда переводим при TRANSFER
  stockItemId      String?         @db.Uuid  // какой тип топлива
  
  createdAt        DateTime        @default(now()) @db.Timestamp(6)
  updatedAt        DateTime        @default(now()) @updatedAt @db.Timestamp(6)

  organization     Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department       Department?     @relation("ResetRuleDepartment", fields: [departmentId], references: [id], onDelete: SetNull)
  targetLocation   StockLocation?  @relation("ResetRuleTarget", fields: [targetLocationId], references: [id], onDelete: SetNull)
  stockItem        StockItem?      @relation("ResetRuleStockItem", fields: [stockItemId], references: [id], onDelete: SetNull)

  @@index([organizationId, isActive, nextRunAt])
  @@map("fuel_card_reset_rules")
}
