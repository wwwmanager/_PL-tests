# Руководство разработчика – Доменные инварианты

## Что такое `runDomainInvariants`?
`runDomainInvariants` – **единственная точка входа**, которая проверяет целостность всех основных доменных сущностей – **Путевой лист (Waybill)**, **Бланк (Blank)** и **Склад (Stock)** – в одном снимке данных (`DomainSnapshot`).

Если нарушен любой инвариант, функция **выбрасывает `Error`** с сообщением, в котором указана проблемная сущность и конкретное правило, которое не выполнено.

```ts
import { runDomainInvariants } from './services/domain/runDomainInvariants';

const snapshot = {
  waybills: await api.getWaybills(),
  blanks: await api.getWaybillBlanks(),
  employees: await api.getEmployees(),
  vehicles: await api.getVehicles(),
  stockItems: await api.getGarageStockItems(),
  stockTransactions: await api.getStockTransactions(),
};

runDomainInvariants(snapshot); // бросит ошибку при первой нарушенной проверке
```

## Где используется?
| Место | Цель |
|------|------|
| **Тест Full Scenario** (`services/mockApi.test.ts`) | Служит *интеграционным маяком* – после выполнения полного сценария проверяется, что весь домен остаётся согласованным. |
| **Dev‑guard** (`services/mockApi.ts`) | В режиме разработки (`import.meta.env.DEV`) функция вызывается после каждой ключевой мутации (добавление/изменение/удаление ПЛ, транзакций склада, бланков и т.д.), чтобы сразу получать обратную связь при ручном тестировании. |
| **Диагностический UI** (`components/admin/Diagnostics.tsx`) | Кнопка «Проверить целостность домена» вызывает лёгкую обёртку `runDomainHealthCheck()`, которая собирает снимок, запускает инварианты и возвращает либо `ok: true`, либо описание ошибки. |

## Типичные сообщения об ошибках
| Инвариант | Пример сообщения | Как читать |
|-----------|------------------|-----------|
| **Blank** | `Нарушение инвариантов бланков:\nБланк blank‑123 (status=used): ownerEmployeeId=driver‑99, но такого сотрудника нет` | Бланк с id `blank‑123` имеет статус `used`, но указывает на несуществующего водителя. |
| **Waybill** | `Нарушение инвариантов путевого листа wb‑7:\nПЛ wb‑7: для used‑бланка blank‑5 должно быть заполнено usedAt` | Путевой лист `wb‑7` ссылается на использованный бланк, у которого отсутствует обязательное поле `usedAt`. |
| **Stock** | `Нарушение инвариантов склада:\nНоменклатура item‑42: сумма транзакций -25, но balance=975` | Сумма всех транзакций для номенклатуры `item‑42` не совпадает с её текущим балансом. |

## Что делать, когда появляется ошибка
1. **Найти сущность** – в сообщении присутствует тип и id (`blank‑123`, `wb‑7`, `item‑42`).
2. **Посмотреть данные** – используйте mock‑API (`await api.get…`) или UI‑инструменты, чтобы увидеть текущие значения.
3. **Исправить причину** – добавьте недостающего сотрудника, задайте `usedAt`, скорректируйте суммы транзакций.
4. **Перезапустить тест / dev‑guard** – ошибка должна исчезнуть.

---

*Обновляйте это руководство по мере добавления новых инвариантов (например, более строгие проверки расхода топлива, проверки по локациям склада, история статусов бланков).*
