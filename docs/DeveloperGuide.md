# Руководство разработчика (Developer Guide)

Этот документ описывает архитектуру системы, ключевые сущности, бизнес-логику и инварианты.

## 1. Архитектура
Система построена по слоистой архитектуре:
- **API / Controllers**: Обработка HTTP-запросов, валидация входных данных, вызов сервисов. (`backend/src/controllers`)
- **Services**: Реализация бизнес-логики. Сервисы не зависят от Express. (`backend/src/services`)
- **Data Access (Prisma)**: Работа с базой данных PostgreSQL через Prisma ORM.

### Основные слои:
- `Backend`: TypeScript + Express + Prisma.
- `Frontend`: React + Vite + TypeScript.
- `Database`: PostgreSQL.

---

## 2. Ключевые модули

### 2.1 Номенклатура (Stock Items)
Справочник товаров и материалов (`StockItem`).
- **Группы (Groups)**: Основной способ классификации.
  - Список групп: *ГСМ, Техжидкости, Запчасти, Шины, АКБ, Агрегаты, Услуги*.
- **Категории (CategoryEnum)**: Внутренний системный флаг для логики (определяется автоматически по группе).
  - `FUEL` (для ГСМ) — включает учет плотности.
  - `SERVICE` (для Услуг) — не имеет остатка.
  - `SPARE_PART` / `MATERIAL` — для остальных.
- **Начальный остаток**: При создании товара можно сразу задать начальный остаток. Система создаст документ корректировки (`INITIAL_BALANCE`).

### 2.2 Модели ТС (Vehicle Models)
Справочник моделей техники (`VehicleModel`).
- Позволяет задавать базовые нормы расхода и емкость бака для группы машин.
- **Наследование**: Если у машины (`Vehicle`) не заданы свои нормы, используются нормы модели.

### 2.3 Путевые листы (Waybills)
Центральный документ учетной системы.
- Связывает водителя, машину и маршрут.
- **Расчет топлива**:
  - `FACT`: По фактическим остаткам (бак на выезде - расход + заправка).
  - `NORM`: По нормам расхода (л/100км или л/ч).
- **Пакетная обработка**: Возможность создавать путевые листы массово.

---

## 3. Доменные инварианты

### Что такое `runDomainInvariants`?
`runDomainInvariants` – **точка проверки целостности** доменных данных. Она проверяет согласованность Путевых листов, Бланков и Склада в одном снимке (`DomainSnapshot`).

Если нарушен любой инвариант, выбрасывается `Error` с подробным описанием.

```ts
import { runDomainInvariants } from './services/domain/runDomainInvariants';

const snapshot = {
  waybills: await api.getWaybills(),
  vehicles: await api.getVehicles(),
  stockItems: await api.getGarageStockItems(),
  // ...
};

runDomainInvariants(snapshot);
```

### Где используется?
1. **Тесты**: `services/mockApi.test.ts` (Full Scenario).
2. **Dev-режим**: Проверка после мутаций данных.
3. **Диагностика**: В админ-панели для ручной проверки `runDomainHealthCheck()`.

### Примеры инвариантов
| Сущность | Проверка |
|---|---|
| **Blank** | Бланк `used` должен ссылаться на существующего водителя. |
| **Waybill** | ПЛ не может ссылаться на уже использованный в другом ПЛ бланк. |
| **Stock** | Сумма всех транзакций по товару должна совпадать с полем `balance` (если оно кэшируется). |

---

## 4. Разработка и тестирование

### Запуск
- **Frontend**: `npm run dev` (в корне)
- **Backend**: `npm run dev` (в папке `backend`)

### Тесты
- Юнит-тесты: `npm test`
- Проверочные скрипты: `backend/src/verify_*.ts` (используйте `npx ts-node ...`)
