# Отчет по предрейсовым осмотрам

## Описание

Отчет по предрейсовым осмотрам предназначен для учета и анализа медицинских осмотров водителей перед выездом на маршрут. Отчет формируется на основе данных путевых листов и позволяет контролировать выполнение требований по проведению предрейсовых медицинских осмотров.

## Расположение

Отчет доступен в разделе **Отчёты** → **Отчёт по предрейсовым осмотрам**.

## Функциональность

### Фильтры отчета

1. **Период дат (обязательно)**:
   - Дата от - начало периода
   - Дата до - конец периода

2. **Дополнительные фильтры**:
   - Все водители / Конкретный водитель
   - Все ТС / Конкретное транспортное средство

### Режимы просмотра

#### 1. Сводный отчет
Показывает агрегированную информацию по каждому водителю:
- **Водитель** - ФИО водителя
- **Всего осмотров** - общее количество предрейсовых осмотров за период
- **Уникальных дат** - количество различных дат, в которые проводились осмотры
- **Транспортные средства** - список ТС, на которых работал водитель

Данные отсортированы по убыванию количества осмотров.

#### 2. Детальный отчет
Показывает полную информацию по каждому осмотру:
- **№** - порядковый номер записи
- **Дата осмотра** - дата проведения осмотра
- **Водитель** - ФИО водителя
- **Транспортное средство** - гос. номер ТС
- **Номер путевого листа** - номер связанного путевого листа

Данные отсортированы по дате осмотра (от новых к старым), затем по водителю.

### Статистика

Под таблицей отображаются итоговые показатели:
- **Всего осмотров** - общее количество осмотров за выбранный период
- **Водителей** - количество уникальных водителей
- **Среднее на водителя** - среднее количество осмотров на одного водителя

## Экспорт данных

Отчет можно экспортировать в формат Excel (.xlsx):
1. Нажмите кнопку **"Экспорт в Excel"**
2. Файл будет сохранен с именем `pretrip_inspections_[дата_от]_[дата_до].xlsx`
3. Экспортируются данные текущего активного режима (сводный или детальный)

### Формат экспорта

**Сводный отчет**:
- Водитель
- Всего осмотров
- Уникальных дат
- Транспортные средства

**Детальный отчет**:
- Дата осмотра
- Водитель
- Транспортное средство
- Номер путевого листа

## Правила подсчета осмотров

Предрейсовый осмотр учитывается для каждой **уникальной даты** в маршрутах путевого листа:

1. Если в путевом листе есть маршруты с указанными датами - считается по каждой уникальной дате
2. Если даты в маршрутах не указаны - используется дата самого путевого листа
3. Если маршрутов нет - считается один осмотр на дату путевого листа

Например:
- Путевой лист от 10.01.2025 с маршрутами на 10.01, 10.01, 11.01 = **2 осмотра** (10.01 и 11.01)
- Путевой лист от 10.01.2025 без маршрутов = **1 осмотр** (10.01)

## Учитываемые путевые листы

В отчет включаются только путевые листы со статусами:
- **Submitted** (На проверке)
- **Posted** (Проведено)

Черновики (Draft) и отмененные (Cancelled) путевые листы в отчет не включаются.

## Примеры использования

### Еженедельный контроль
1. Установите период: с понедельника по воскресенье
2. Выберите "Сводный отчет"
3. Проверьте, что каждый водитель прошел необходимое количество осмотров

### Проверка конкретного водителя
1. Установите нужный период
2. Выберите водителя из списка
3. Переключитесь на "Детальный отчет"
4. Проверьте все даты и связанные путевые листы

### Месячный отчет
1. Установите период: первый и последний день месяца
2. Выберите "Сводный отчет"
3. Экспортируйте данные для архива или отчетности

## Техническая информация

### Компонент
- Файл: `components/reports/PreTripInspectionReport.tsx`
- Родительский компонент: `components/reports/Reports.tsx`

### API функции
- `fetchWaybills()` - получение путевых листов
- `fetchDrivers()` - получение списка водителей
- `fetchVehicles()` - получение списка транспортных средств
- `getMedicalExamsCount()` - подсчет количества осмотров для путевого листа

### Типы данных
```typescript
interface InspectionRow {
  driverId: string;
  driverName: string;
  vehicleId: string;
  vehiclePlate: string;
  inspectionDate: string;
  waybillNumber: string;
  waybillId: string;
}

interface InspectionSummary {
  driverId: string;
  driverName: string;
  totalInspections: number;
  inspectionDates: string[];
  vehiclesUsed: string[];
}
```

## Интеграция с другими модулями

Отчет по предрейсовым осмотрам интегрирован с:
1. **Путевые листы** - источник данных об осмотрах
2. **Справочник водителей** - информация о сотрудниках
3. **Справочник ТС** - информация о транспортных средствах
4. **Dashboard** - использует ту же функцию `getMedicalExamsCount()` для статистики

## Требования законодательства

Предрейсовые медицинские осмотры являются обязательными согласно:
- Приказ Минздрава России от 15.12.2014 N 835н
- Федеральный закон от 10.12.1995 N 196-ФЗ "О безопасности дорожного движения"

Отчет помогает соблюдать эти требования и вести необходимую документацию.
